<% if user_signed_in? %>
  <% question_obj = local_assigns[:question] || @question %>
  <% unique_id = local_assigns[:unique_id] %>
  <% if question_obj.liked_by?(current_user) %>
    <!-- ♥ 登録済み：モーダルを開く -->
    <div id="<%= unique_id %>" class="favorite-btn-question-<%= question_obj.id %>" data-controller="favorite-modal">
      <button
        type="button"
        class="favorite-button text-error flex items-center justify-center text-2xl"
        data-action="click->favorite-modal#open"
      >
        <i class="fa-solid fa-heart"></i>
      </button>

      <!-- モーダル本体 -->
      <dialog id="list-modal-<%= unique_id %>" class="modal" data-favorite-modal-target="modal">
      <div class="modal-box">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-lg">リスト登録を解除</h3>
          <%= button_to question_list_questions_path(question_obj),
                method: :delete,
                params: { unique_id: unique_id, context: 'game_records' },
                class: "favorite-button btn btn-error btn-sm" do %>
            リスト登録を全て解除
          <% end %>
        </div>

        <div class="divider"></div>
        <h3 class="font-bold text-lg mb-4">登録リストを変更</h3>
        <%# 複数リストに対応したチェックボックスフォーム %>
        <%= form_with url: update_multiple_question_list_questions_path(question_obj, unique_id: unique_id, context: 'game_records'), method: :patch do %>
          <div class="space-y-3">
            <% current_user.lists.each do |list| %>
              <% checked = list.questions.exists?(question_obj.id) %>
              <label class="flex items-center space-x-2 cursor-pointer">
                <%= check_box_tag "list_ids[]", list.id, checked, class: "checkbox checkbox-primary checkbox-sm" %>
                <span><%= list.name %></span>
              </label>
            <% end %>
          </div>

          <div class="flex justify-end space-x-2 mt-4">
            <form method="dialog">
              <button class="btn btn-outline btn-sm">キャンセル</button>
            </form>
            <button type="submit" class="btn btn-primary btn-sm">更新</button>
          </div>
        <% end %>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>閉じる</button>
      </form>
    </dialog>
    </div>

  <% else %>
    <!-- ♡ 未登録：お気に入りに追加 -->
    <div id="<%= unique_id %>" class="favorite-btn-question-<%= question_obj.id %>">
      <%= button_to question_list_questions_path(question_obj),
                    method: :post,
                    params: { unique_id: unique_id, context: 'game_records' },
                    class: "favorite-button text-error flex items-center justify-center text-2xl" do %>
        <i class="fa-regular fa-heart"></i>
      <% end %>
    </div>
  <% end %>
<% end %>
